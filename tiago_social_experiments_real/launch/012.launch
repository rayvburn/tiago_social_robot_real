<?xml version="1.0" encoding="UTF-8"?>
<launch>
    <!-- === ARGUMENTS ========================================================================== -->
    <!-- (devel|static|dynamic|passing_in_front|overtaking|crossing|hall_passing_group) -->
    <arg name="scenario" default="devel"/>
    <!-- scenario stage: (run|return) -->
    <!-- 'run'  is used to start at begin pose and finish at goal, logging experiments data throughout the journey -->
    <!-- 'return' is used to go back to scenario's start position while at the end -->
    <arg name="stage" default=""/>

    <arg name="perception_launch" default="true"/>
    <arg name="perception_input_topic" default="/spencer/perception/tracked_persons_confirmed_by_HOG_or_upper_body"/>

    <arg name="navigation_launch" default="true"/>
    <arg name="navigation_benchmark" default="true"/>
    <arg name="external_map" default="false"/>

    <arg name="global_planner" default="navfn"/>
    <arg name="local_planner" default="teb"/>
    <arg name="costmap_contexts" default="social"/>
    <arg name="nav_state" default="localization"/>

    <arg name="narrow_laser_range" default="false"/>

    <!-- Run debugging tools -->
    <arg name="run_perception_viz" default="false"/>
    <arg name="run_nav_viz" default="false"/>
    <arg name="run_reconfigure" default="false"/>
    <arg name="run_plot" default="false"/>

    <!-- Automatic publishing of navigation goal -->
    <arg name="publish_goal" default="true"/>
    <arg name="publish_goal_delay" default="10"/>
    <arg name="goal_file" value="$(find tiago_social_experiments_real)/config/012_goal.yaml"/>

    <!-- Location-specific -->
    <!-- Some scenarios require only the map covering only the laboratory space (backward compatibility for reproducing
    the SRPB experiments) -->
    <arg name="map_file" value="$(find tiago_sim_integration)/maps/012_sim_localization/map.yaml"
        if="$(eval scenario == 'static' or scenario == 'dynamic')"
    />
    <!-- Other scenarios require/are adjusted to the map covering the laboratory with the neighbouring corridor -->
    <arg name="map_file" value="$(find tiago_sim_integration)/maps/012_extended_ftl_sim_localization/extended_map_lab_deletions_and_additions.yaml"
        if="$(eval scenario == 'passing_in_front' or scenario == 'overtaking' or scenario == 'crossing' or scenario == 'hall_passing_group')"
    />
    <!-- Devel should use the most recent map available -->
    <arg name="map_file" value="$(find tiago_sim_integration)/maps/012_extended_ftl_sim_localization/extended_map_lab_deletions_and_additions.yaml"
        if="$(eval scenario == 'devel')"
    />
    <arg name="allow_clearing_map_obstacles" default="true"/>

    <!-- === NODES ============================================================================== -->
    <include file="$(find tiago_social_bringup)/launch/nav_perception_bringup.launch">
        <arg name="nav_state" value="$(arg nav_state)"/>
        <arg name="narrow_laser_range" value="$(arg narrow_laser_range)"/>
        <arg name="navigation_launch" value="$(arg navigation_launch)"/>
        <arg name="external_map" value="$(arg external_map)"/>
        <arg name="map_file" value="$(arg map_file)"/>
        <arg name="allow_clearing_map_obstacles" value="$(arg allow_clearing_map_obstacles)"/>
        <arg name="global_planner" value="$(arg global_planner)"/>
        <arg name="local_planner" value="$(arg local_planner)"/>
        <arg name="costmap_contexts" value="$(arg costmap_contexts)"/>

        <!-- benchmark should be running only when selected and stage is 'run' -->
        <arg name="navigation_benchmark" if="$(eval stage == 'run')" value="$(arg navigation_benchmark)"/>
        <arg name="navigation_benchmark" if="$(eval stage == 'return')" value="false"/>
        <arg name="perception_launch" value="$(arg perception_launch)"/>
        <arg name="perception_input_topic" value="$(arg perception_input_topic)"/>
        <arg name="publish_goal" value="$(arg publish_goal)"/>
        <arg name="publish_goal_delay" value="$(arg publish_goal_delay)"/>

        <!-- debugging tools -->
        <arg name="run_perception_viz" value="$(arg run_perception_viz)"/>
        <arg name="run_nav_viz" value="$(arg run_nav_viz)"/>
        <arg name="run_reconfigure" value="$(arg run_reconfigure)"/>
        <arg name="run_plot" value="$(arg run_plot)"/>

        <!-- select localization estimate -->
        <!-- older scenarios -->
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'static' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/static/start_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'static' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/static/finish_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'dynamic' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/undock_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'dynamic' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/dynamic/finish_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'devel')"
            value="$(find tiago_social_experiments_real)/config/012/undock_ftl_amcl.yaml"
        />
        <!-- newer scenarios -->
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'passing_in_front' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/passing_in_front/start_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'passing_in_front' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/passing_in_front/finish_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'overtaking' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/overtaking/start_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'overtaking' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/overtaking/finish_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'crossing' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/crossing/start_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'crossing' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/crossing/finish_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'hall_passing_group' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/hall_passing_group/start_amcl.yaml"
        />
        <arg name="localization_pose_estimate"
            if="$(eval scenario == 'hall_passing_group' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/hall_passing_group/finish_amcl.yaml"
        />

        <!-- select goal -->
        <!-- older scenarios -->
        <arg name="goal_file"
            if="$(eval scenario == 'static' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/static/finish_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'static' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/static/start_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'dynamic' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/dynamic/finish_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'dynamic' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/undock_pose.yaml"
        />
        <!-- newer scenarios -->
        <arg name="goal_file"
            if="$(eval scenario == 'passing_in_front' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/passing_in_front/finish_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'passing_in_front' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/passing_in_front/start_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'overtaking' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/overtaking/finish_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'overtaking' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/overtaking/start_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'crossing' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/crossing/finish_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'crossing' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/crossing/start_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'hall_passing_group' and stage == 'run')"
            value="$(find tiago_social_experiments_real)/config/012/hall_passing_group/finish_pose.yaml"
        />
        <arg name="goal_file"
            if="$(eval scenario == 'hall_passing_group' and stage == 'return')"
            value="$(find tiago_social_experiments_real)/config/012/hall_passing_group/start_pose.yaml"
        />

        <!-- prevent from running anywhere even with publish_goal -->
        <arg name="goal_file"
            if="$(eval scenario == 'devel')"
            value="$(find tiago_social_experiments_real)/config/012/undock_ftl_pose.yaml"
        />
    </include>

    <!--
        move the head slightly down (tilt angle) to observe close environment better, however, too big angle will
        likely cause false positives in obstacle detection, e.g., at -0.275 DWA planner gets stuck often
    -->
    <node pkg="play_motion" type="move_joint" name="move_jnt_head_tilt" output="screen" args="head_2_joint -0.1 2.0"/>
    <!-- head (RGBD camera) pointing forward -->
    <node pkg="play_motion" type="move_joint" name="move_jnt_head_pan" output="screen" args="head_1_joint +0.0 2.0"/>
</launch>
